#!/bin/bash

RED="31"
GREEN="32"
GRAY="90"
BOLDGREEN="\033[1;${GREEN}m"
BOLDRED="\033[1;${RED}m"
BOLDGRAY="\033[1;${GRAY}m"
ENDCOLOR="\033[0m"

ERRORS=()

# helper functions
progress_message() {
  printf "${BOLDGREEN}%s${ENDCOLOR}" "$1"
}

error_message() {
  printf "${BOLDRED}%s${ENDCOLOR}" "$1" >&2
}

message() {
  printf "${BOLDGRAY}%s${ENDCOLOR}\n" "$1"
}

execute_command() {
  progress_message "$2..."

  if output=$(eval "$1" 2>&1); then
    progress_message "Ok!"
    printf "\n"
  else
    error_message "Fail!"
    printf "\n"
    ERRORS+=("> $1\n${output}\n\n")
  fi
}

# Install Xcode Command Line Tools if not already installed
if ! xcode-select -p >/dev/null 2>&1; then
  execute_command "xcode-select --install" \
    "> Open the GUI prompt to install Xcode Command Line Tools"
  message "Please finish installing the Xcode Command Line Tools, then re-run this script."
  exit 1
else
  message "> Xcode Command Line Tools already installed"
fi

# Check for Homebrew to be present, install if it's missing
if test ! $(which brew); then
  message "> Installing homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install Homebrew packages
execute_command "brew bundle" \
  "> Installing Homebrew packages"

# Setup login shell from homebrew
BREW_PREFIX="$(brew --prefix)"
NEW_SHELL="$BREW_PREFIX/bin/bash"

execute_command \
  "grep -Fxq $NEW_SHELL /etc/shells || echo $NEW_SHELL | sudo tee -a /etc/shells" \
  "> Adding Homebrew bash to /etc/shells"

execute_command \
  "chsh -s $NEW_SHELL" \
  "> Changing login shell to Homebrew bash"

# Check for tmux/tpm to be present, install if it's missing
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
  execute_command "git clone https://github.com/tmux-plugins/tpm ${HOME}/.tmux/plugins/tpm" \
    "> Installing Tmux Package Manager"
fi

if [ ${#ERRORS[@]} -gt 0 ]; then
  printf "\n${BOLDRED}The following errors occurred:${ENDCOLOR}\n"
  printf "%b" "${ERRORS[@]}"
fi
